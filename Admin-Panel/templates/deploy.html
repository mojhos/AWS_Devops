{% extends "base.html" %}
{% block content %}
<h3>Deploy</h3>

<form method="post">
  <input type="hidden" name="action" value="clone">
  <div class="mb-3">
    <label class="form-label">GitHub Repo URL</label>
    <input class="form-control" name="repo_url" value="{{ repo_url }}">
  </div>
  <button class="btn btn-secondary">Clone / Pull</button>
</form>

<hr>
<h5>Variables</h5>
<form method="post" action="{{ url_for('tfvars') }}">
  {% if variables %}
    {% for name, attrs in variables.items() %}
      <div class="mb-2">
        <label><strong>{{ name }}</strong> <small class="text-muted">{{ attrs.description }}</small></label>
        <input class="form-control" name="var___{{ name }}" placeholder="{{ attrs.default }}">
      </div>
    {% endfor %}
    <button class="btn btn-primary mt-2">Save terraform.tfvars</button>
  {% else %}
    <p class="text-muted">No variables found.</p>
  {% endif %}
</form>

<hr>
<h5>Terraform Console</h5>
<div class="btn-group">
  <button class="btn btn-outline-dark" onclick="runCmd('init')">Init</button>
  <button class="btn btn-outline-dark" onclick="runCmd('plan')">Plan</button>
  <button class="btn btn-success" onclick="runCmd('apply')">Apply</button>
  <button class="btn btn-danger" onclick="runCmd('destroy')">Destroy</button>
  <button class="btn btn-outline-primary" onclick="runCmd('state')">Show State</button>
</div>

<!-- Clear Console button -->
<button class="btn btn-light ms-3" onclick="clearLogs()">Clear Console</button>

<div id="log-box" 
     style="height:90vh;
            overflow-y:auto;
            background:#111;
            color:#eee;
            padding:1rem;
            margin-top:1rem;
            font-family:monospace;
            border-radius:8px;
            border:1px solid #333;">
</div>
<script>
const box = document.getElementById('log-box');

// Restore saved logs
const saved = localStorage.getItem('terraform_logs');
if (saved) box.innerHTML = saved;

async function runCmd(cmd) {
  const resp = await fetch('/' + cmd);
  const reader = resp.body.getReader();
  const decoder = new TextDecoder();

  // keep appending to the existing log
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value);
    box.innerHTML += chunk;
    localStorage.setItem('terraform_logs', box.innerHTML);
    box.scrollTop = box.scrollHeight;
  }
}

// optional: clear logs
function clearLogs() {
  box.innerHTML = '';
  localStorage.removeItem('terraform_logs');
}
</script>

{% endblock %}
